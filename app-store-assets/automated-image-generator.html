<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Image Generator - App Store Assets</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .upload-section {
            margin: 30px 0;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            text-align: center;
            transition: all 0.3s ease;
        }
        .upload-section.dragover {
            border-color: #4A90E2;
            background: rgba(74, 144, 226, 0.1);
            transform: scale(1.02);
        }
        .upload-area {
            padding: 40px 20px;
            cursor: pointer;
        }
        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.7;
        }
        .upload-text {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .upload-subtext {
            font-size: 0.9em;
            opacity: 0.7;
        }
        #fileInput {
            display: none;
        }
        .source-preview {
            margin: 20px 0;
            text-align: center;
            display: none;
        }
        .source-preview img {
            max-width: 300px;
            max-height: 300px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: white;
        }
        .btn {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin: 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #50C878, #45B068);
        }
        .btn-danger {
            background: linear-gradient(135deg, #FF6B6B, #FF5252);
        }
        .generation-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }
        .progress-container {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4A90E2, #50C878);
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: center;
            font-size: 14px;
            margin: 10px 0;
        }
        .generated-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .image-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .image-card img {
            max-width: 100%;
            height: auto;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: white;
            margin-bottom: 10px;
        }
        .image-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .image-specs {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 10px;
        }
        .status-message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        .status-success {
            background: rgba(108, 207, 127, 0.2);
            border: 1px solid rgba(108, 207, 127, 0.5);
            color: #6BCF7F;
        }
        .status-error {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid rgba(255, 71, 87, 0.5);
            color: #FF4757;
        }
        .status-info {
            background: rgba(74, 144, 226, 0.2);
            border: 1px solid rgba(74, 144, 226, 0.5);
            color: #4A90E2;
        }
        canvas {
            display: none;
        }
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            border-left: 4px solid #4A90E2;
        }
        .url-input-container input[type="url"] {
            transition: all 0.3s ease;
        }
        .url-input-container input[type="url"]:focus {
            outline: none;
            border-color: #4A90E2;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        .url-input-container input[type="url"]::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .url-preview img {
            transition: all 0.3s ease;
        }
        .url-preview img:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4A90E2;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .paste-area {
            padding: 30px 20px;
            text-align: center;
            transition: all 0.3s ease;
            border-radius: 10px;
        }
        .paste-area.paste-ready {
            background: rgba(108, 207, 127, 0.1);
            border: 2px dashed rgba(108, 207, 127, 0.5);
            transform: scale(1.02);
        }
        .paste-area.paste-active {
            background: rgba(74, 144, 226, 0.1);
            border: 2px dashed rgba(74, 144, 226, 0.5);
            transform: scale(1.05);
        }
        .paste-preview img {
            transition: all 0.3s ease;
        }
        .paste-preview img:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        kbd {
            font-family: monospace;
            font-size: 0.9em;
        }
        .paste-success {
            background: rgba(108, 207, 127, 0.2);
            border: 1px solid rgba(108, 207, 127, 0.5);
            color: #6BCF7F;
            padding: 8px 12px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 10px;
        }
        .paste-error {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid rgba(255, 71, 87, 0.5);
            color: #FF4757;
            padding: 8px 12px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align: center;">
            <h1>üé® Automated Image Generator</h1>
            <p style="font-size: 1.1em; opacity: 0.9; margin: 10px 0;">
                Upload, paste, or load from URL - automatically generate all 5 required app store images
            </p>
            <div style="font-size: 0.9em; opacity: 0.7; margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                üí° <strong>Quick Tip:</strong> Press <kbd style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">Ctrl+V</kbd> (or <kbd style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">Cmd+V</kbd>) to paste images from clipboard
            </div>
            <div style="margin: 15px 0;">
                <a href="enhanced-converter.html" class="btn" style="text-decoration: none; display: inline-block;">
                    ‚Üê Back to Enhanced Converter
                </a>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Click to upload or drag & drop your image</div>
                <div class="upload-subtext">Supports PNG, JPG/JPEG, and SVG files</div>
            </div>
            <input type="file" id="fileInput" accept="image/png,image/jpeg,image/jpg,image/svg+xml">
        </div>

        <!-- Paste Section -->
        <div class="upload-section" id="pasteSection">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 1.5em; margin-bottom: 10px;">üìã</div>
                <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 5px;">Or Paste from Clipboard</div>
                <div style="font-size: 0.9em; opacity: 0.7;">Press Ctrl+V (Cmd+V on Mac) to paste images</div>
            </div>
            <div class="paste-area" id="pasteArea">
                <div class="paste-icon" style="font-size: 3em; margin-bottom: 15px; opacity: 0.6;">üìã</div>
                <div style="font-size: 1.1em; margin-bottom: 8px;">Ready for paste</div>
                <div style="font-size: 0.9em; opacity: 0.7;">Screenshots, copied images, or clipboard content</div>
                <div class="paste-status" id="pasteStatus" style="margin-top: 15px; font-size: 0.85em; opacity: 0.8;">
                    Click anywhere on this page, then press <kbd style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">Ctrl+V</kbd>
                </div>
            </div>
            <div class="paste-preview" id="pastePreview" style="display: none; margin-top: 20px; text-align: center;">
                <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">Pasted Image Preview:</div>
                <img id="pastePreviewImage" style="max-width: 200px; max-height: 200px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: white;">
            </div>
        </div>

        <!-- URL Input Section -->
        <div class="upload-section" id="urlSection">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 1.5em; margin-bottom: 10px;">üîó</div>
                <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 5px;">Or Enter Image URL</div>
                <div style="font-size: 0.9em; opacity: 0.7;">Load an image directly from a web URL</div>
            </div>
            <div class="url-input-container">
                <input type="url" id="imageUrlInput" placeholder="https://example.com/image.png"
                       style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.3);
                              border-radius: 8px; background: rgba(255,255,255,0.1); color: white;
                              font-size: 14px; margin-bottom: 15px;">
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="loadImageFromUrl()" id="loadUrlBtn">
                        üîó Load Image from URL
                    </button>
                    <button class="btn" onclick="clearUrlInput()" id="clearUrlBtn" style="display: none;">
                        üóëÔ∏è Clear URL
                    </button>
                </div>
            </div>
            <div class="url-preview" id="urlPreview" style="display: none; margin-top: 20px; text-align: center;">
                <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">URL Preview:</div>
                <img id="urlPreviewImage" style="max-width: 200px; max-height: 200px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: white;">
            </div>
        </div>

        <!-- Source Image Preview -->
        <div class="source-preview" id="sourcePreview">
            <h3>Source Image</h3>
            <img id="sourceImage" alt="Source Image">
            <div style="margin: 15px 0;">
                <button class="btn btn-primary" onclick="generateAllImages()">
                    üöÄ Generate All App Store Images
                </button>
                <button class="btn btn-danger" onclick="clearUpload()">
                    üóëÔ∏è Clear & Upload New
                </button>
            </div>
        </div>

        <!-- Generation Progress -->
        <div class="generation-section" id="generationSection">
            <h3>üîÑ Generating Images...</h3>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Preparing...</div>
            </div>
        </div>

        <!-- Generated Images Display -->
        <div class="generation-section" id="resultsSection">
            <h3>‚úÖ Generated Images</h3>
            <div class="generated-images" id="generatedImages">
                <!-- Generated images will be inserted here -->
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-primary" onclick="downloadAllImages()">
                    üì• Download All Images
                </button>
                <button class="btn" onclick="regenerateImages()">
                    üîÑ Regenerate Images
                </button>
                <button class="btn btn-danger" onclick="clearUpload()">
                    üóëÔ∏è Start Over
                </button>
            </div>
            <div style="text-align: center; margin: 10px 0; font-size: 14px; opacity: 0.8;">
                <p>‚úÖ All images meet exact app store requirements</p>
                <p>üì± Ready for immediate app store submission</p>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusContainer"></div>

        <!-- Instructions -->
        <div class="instructions">
            <h3>üìã How It Works</h3>
            <ul>
                <li><strong>Upload, Paste, or URL:</strong> Choose a high-quality source image by uploading a file, pasting from clipboard, or entering an image URL</li>
                <li><strong>Clipboard Support:</strong> Paste screenshots, copied images, or image URLs directly with Ctrl+V (Cmd+V on Mac)</li>
                <li><strong>URL Support:</strong> Load images directly from web URLs (supports common image hosting sites)</li>
                <li><strong>Automatic Generation:</strong> Creates 5 optimized images with proper dimensions</li>
                <li><strong>App Store Icon (512√ó512):</strong> Square format with 10% padding</li>
                <li><strong>Small App Icon (114√ó114):</strong> Square format for notifications</li>
                <li><strong>Feature Graphics (1280√ó800) √ó 3:</strong> Landscape format with white background</li>
                <li><strong>Download:</strong> Get all images individually or as a batch</li>
            </ul>
            <div style="margin-top: 15px; padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px; border-left: 3px solid #4A90E2;">
                <strong>üí° Pro Tips:</strong>
                <ul style="margin: 10px 0 0 0;">
                    <li>For best results, use images with minimum 512√ó512px resolution</li>
                    <li>Paste works with screenshots, copied images from browsers, and design tools</li>
                    <li>URL images are automatically validated for size and format</li>
                    <li>Supported URL sources: Direct image links, Imgur, Unsplash, Pexels, Pixabay</li>
                </ul>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(108, 207, 127, 0.1); border-radius: 8px; border-left: 3px solid #6BCF7F;">
                <strong>üöÄ Quick Methods:</strong>
                <ul style="margin: 10px 0 0 0;">
                    <li><strong>Screenshots:</strong> Take a screenshot (Print Screen, Cmd+Shift+4, etc.) then paste here</li>
                    <li><strong>Copy from Browser:</strong> Right-click any image ‚Üí Copy, then paste here</li>
                    <li><strong>Design Tools:</strong> Copy from Photoshop, Figma, Canva, etc. then paste here</li>
                    <li><strong>Image URLs:</strong> Copy an image URL and paste it to auto-load</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Hidden canvases for image processing -->
    <canvas id="processingCanvas"></canvas>
    <canvas id="tempCanvas"></canvas>

    <script>
        // Global variables
        let sourceImageFile = null;
        let sourceImageData = null;
        let generatedImages = [];

        // Initialize clipboard paste functionality
        function initializeClipboardPaste() {
            // Add paste event listener to document
            document.addEventListener('paste', handlePasteEvent);

            // Add visual feedback for paste readiness
            document.addEventListener('focus', updatePasteStatus);
            document.addEventListener('click', updatePasteStatus);

            // Update initial paste status
            updatePasteStatus();
        }

        // Handle paste events
        async function handlePasteEvent(e) {
            e.preventDefault();

            const pasteArea = document.getElementById('pasteArea');
            const pasteStatus = document.getElementById('pasteStatus');

            // Add visual feedback
            pasteArea.classList.add('paste-active');
            pasteStatus.innerHTML = '<span class="loading-spinner"></span>Processing paste...';

            try {
                const clipboardItems = e.clipboardData.items;
                let imageFound = false;

                // Look for image data in clipboard
                for (let i = 0; i < clipboardItems.length; i++) {
                    const item = clipboardItems[i];

                    if (item.type.startsWith('image/')) {
                        imageFound = true;
                        const file = item.getAsFile();

                        if (file) {
                            await handlePastedImage(file);
                            break;
                        }
                    }
                }

                if (!imageFound) {
                    // Check for text that might be an image URL
                    const text = e.clipboardData.getData('text/plain');
                    if (text && isValidImageUrl(text)) {
                        // Auto-fill URL input and load
                        document.getElementById('imageUrlInput').value = text;
                        await loadImageFromUrl();
                        pasteStatus.innerHTML = '<div class="paste-success">‚úÖ Image URL pasted and loaded!</div>';
                    } else {
                        throw new Error('No image found in clipboard. Try copying an image or screenshot first.');
                    }
                }

            } catch (error) {
                console.error('Paste error:', error);
                pasteStatus.innerHTML = `<div class="paste-error">‚ùå ${error.message}</div>`;
                showStatus(error.message, 'error');
            } finally {
                // Remove visual feedback
                setTimeout(() => {
                    pasteArea.classList.remove('paste-active');
                    if (!pasteStatus.innerHTML.includes('paste-success') && !pasteStatus.innerHTML.includes('paste-error')) {
                        updatePasteStatus();
                    }
                }, 2000);
            }
        }

        // Handle pasted image file
        async function handlePastedImage(file) {
            const pasteStatus = document.getElementById('pasteStatus');
            const pastePreview = document.getElementById('pastePreview');
            const pastePreviewImage = document.getElementById('pastePreviewImage');

            try {
                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    throw new Error('Pasted image is too large (max 10MB)');
                }

                // Create a synthetic filename based on current time
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const syntheticFile = new File([file], `pasted-image-${timestamp}.${file.type.split('/')[1]}`, {
                    type: file.type,
                    lastModified: Date.now()
                });

                // Validate image dimensions for raster images
                if (file.type.startsWith('image/') && file.type !== 'image/svg+xml') {
                    await new Promise((resolve, reject) => {
                        validateImageDimensions(syntheticFile, (isValid, width, height) => {
                            if (!isValid) {
                                reject(new Error(`Pasted image too small: ${width}√ó${height}px. Minimum recommended: 256√ó256px`));
                                return;
                            }
                            resolve();
                        });
                    });
                }

                // Load the pasted image
                sourceImageFile = syntheticFile;
                await loadSourceImageFromFile(syntheticFile);

                // Show paste preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    pastePreviewImage.src = e.target.result;
                    pastePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);

                // Update status
                pasteStatus.innerHTML = '<div class="paste-success">‚úÖ Image pasted successfully!</div>';
                showStatus(`Image pasted from clipboard (${file.type})`, 'success');

            } catch (error) {
                throw error; // Re-throw to be handled by parent function
            }
        }

        // Update paste status based on focus
        function updatePasteStatus() {
            const pasteStatus = document.getElementById('pasteStatus');
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const shortcut = isMac ? 'Cmd+V' : 'Ctrl+V';

            if (document.hasFocus()) {
                pasteStatus.innerHTML = `Ready to paste! Press <kbd style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">${shortcut}</kbd>`;
                document.getElementById('pasteArea').classList.add('paste-ready');
            } else {
                pasteStatus.innerHTML = `Click anywhere on this page, then press <kbd style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">${shortcut}</kbd>`;
                document.getElementById('pasteArea').classList.remove('paste-ready');
            }
        }

        // Load source image from file (helper function)
        async function loadSourceImageFromFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const img = document.getElementById('sourceImage');
                    img.src = e.target.result;
                    sourceImageData = e.target.result;

                    document.getElementById('sourcePreview').style.display = 'block';
                    resolve();
                };

                reader.onerror = function() {
                    reject(new Error('Error loading pasted image file'));
                };

                reader.readAsDataURL(file);
            });
        }

        // Initialize drag and drop functionality
        function initializeDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadSection.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadSection.classList.add('dragover');
            }

            function unhighlight(e) {
                uploadSection.classList.remove('dragover');
            }

            uploadSection.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
        }

        // Handle file input change
        document.getElementById('fileInput').addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });

        // Handle URL input enter key
        document.getElementById('imageUrlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadImageFromUrl();
            }
        });

        // Handle URL input changes for real-time validation
        document.getElementById('imageUrlInput').addEventListener('input', function(e) {
            const url = e.target.value.trim();
            const loadBtn = document.getElementById('loadUrlBtn');
            const clearBtn = document.getElementById('clearUrlBtn');

            if (url) {
                clearBtn.style.display = 'inline-block';
                if (isValidImageUrl(url)) {
                    loadBtn.disabled = false;
                    e.target.style.borderColor = 'rgba(108, 207, 127, 0.5)';
                } else {
                    loadBtn.disabled = true;
                    e.target.style.borderColor = 'rgba(255, 71, 87, 0.5)';
                }
            } else {
                clearBtn.style.display = 'none';
                loadBtn.disabled = false;
                e.target.style.borderColor = 'rgba(255,255,255,0.3)';
            }
        });

        // Handle uploaded files
        function handleFiles(files) {
            if (files.length === 0) return;

            const file = files[0];

            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
            const validExtensions = ['.png', '.jpg', '.jpeg', '.svg'];
            const fileName = file.name.toLowerCase();
            const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));

            if (!validTypes.includes(file.type) && !hasValidExtension) {
                showStatus('Please upload a PNG, JPG, or SVG file.', 'error');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showStatus('File size must be less than 10MB.', 'error');
                return;
            }

            // Validate minimum dimensions for raster images
            if (file.type.startsWith('image/') && file.type !== 'image/svg+xml') {
                validateImageDimensions(file, (isValid, width, height) => {
                    if (!isValid) {
                        showStatus(`Image too small. Minimum recommended: 512√ó512px. Your image: ${width}√ó${height}px`, 'error');
                        return;
                    }
                    sourceImageFile = file;
                    loadSourceImage(file);
                });
            } else {
                sourceImageFile = file;
                loadSourceImage(file);
            }
        }

        // Validate image dimensions
        function validateImageDimensions(file, callback) {
            const img = new Image();
            const url = URL.createObjectURL(file);

            img.onload = function() {
                URL.revokeObjectURL(url);
                const minSize = 256; // Minimum recommended size
                const isValid = img.width >= minSize && img.height >= minSize;
                callback(isValid, img.width, img.height);
            };

            img.onerror = function() {
                URL.revokeObjectURL(url);
                callback(false, 0, 0);
            };

            img.src = url;
        }

        // Load and display source image
        function loadSourceImage(file) {
            const reader = new FileReader();

            reader.onload = function(e) {
                const img = document.getElementById('sourceImage');
                img.src = e.target.result;
                sourceImageData = e.target.result;

                document.getElementById('sourcePreview').style.display = 'block';
                showStatus(`Source image loaded: ${file.name}`, 'success');
            };

            reader.onerror = function() {
                showStatus('Error loading image file.', 'error');
            };

            reader.readAsDataURL(file);
        }

        // Validate if URL looks like an image URL
        function isValidImageUrl(url) {
            try {
                const urlObj = new URL(url);
                const pathname = urlObj.pathname.toLowerCase();
                const validExtensions = ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.svg', '.bmp'];
                return validExtensions.some(ext => pathname.endsWith(ext)) ||
                       url.includes('imgur.com') ||
                       url.includes('unsplash.com') ||
                       url.includes('pexels.com') ||
                       url.includes('pixabay.com') ||
                       url.includes('githubusercontent.com');
            } catch {
                return false;
            }
        }

        // Load image from URL
        async function loadImageFromUrl() {
            const urlInput = document.getElementById('imageUrlInput');
            const url = urlInput.value.trim();
            const loadBtn = document.getElementById('loadUrlBtn');
            const urlPreview = document.getElementById('urlPreview');
            const urlPreviewImage = document.getElementById('urlPreviewImage');

            if (!url) {
                showStatus('Please enter an image URL.', 'error');
                return;
            }

            // Basic URL validation
            try {
                new URL(url);
            } catch {
                showStatus('Please enter a valid URL.', 'error');
                return;
            }

            // Show loading state
            const originalText = loadBtn.innerHTML;
            loadBtn.innerHTML = '<span class="loading-spinner"></span>Loading...';
            loadBtn.disabled = true;

            try {
                // First, try to load the image to validate it
                const img = new Image();
                img.crossOrigin = 'anonymous'; // Enable CORS for external images

                const imageLoadPromise = new Promise((resolve, reject) => {
                    img.onload = () => {
                        // Validate image dimensions
                        if (img.width < 100 || img.height < 100) {
                            reject(new Error(`Image too small: ${img.width}√ó${img.height}px. Minimum recommended: 256√ó256px`));
                            return;
                        }
                        resolve(img);
                    };
                    img.onerror = () => reject(new Error('Failed to load image from URL. Please check the URL and try again.'));
                });

                // Set timeout for loading
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Image loading timed out. Please try a different URL.')), 10000);
                });

                img.src = url;

                // Wait for image to load or timeout
                const loadedImg = await Promise.race([imageLoadPromise, timeoutPromise]);

                // Convert image to data URL
                const canvas = document.getElementById('tempCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = loadedImg.width;
                canvas.height = loadedImg.height;

                ctx.drawImage(loadedImg, 0, 0);
                const dataUrl = canvas.toDataURL('image/png');

                // Set as source image
                sourceImageData = dataUrl;
                sourceImageFile = { name: `image-from-url-${Date.now()}.png`, size: dataUrl.length };

                // Update UI
                const sourceImg = document.getElementById('sourceImage');
                sourceImg.src = dataUrl;
                document.getElementById('sourcePreview').style.display = 'block';

                // Show URL preview
                urlPreviewImage.src = dataUrl;
                urlPreview.style.display = 'block';

                showStatus(`Image loaded successfully from URL (${loadedImg.width}√ó${loadedImg.height}px)`, 'success');

            } catch (error) {
                console.error('URL loading error:', error);
                showStatus(error.message, 'error');
                urlPreview.style.display = 'none';
            } finally {
                // Restore button state
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
            }
        }

        // Clear URL input
        function clearUrlInput() {
            const urlInput = document.getElementById('imageUrlInput');
            const urlPreview = document.getElementById('urlPreview');
            const clearBtn = document.getElementById('clearUrlBtn');

            urlInput.value = '';
            urlInput.style.borderColor = 'rgba(255,255,255,0.3)';
            urlPreview.style.display = 'none';
            clearBtn.style.display = 'none';

            showStatus('URL input cleared.', 'info');
        }

        // Clear upload and reset
        function clearUpload() {
            sourceImageFile = null;
            sourceImageData = null;
            generatedImages = [];

            document.getElementById('sourcePreview').style.display = 'none';
            document.getElementById('generationSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('fileInput').value = '';

            // Clear URL input as well
            clearUrlInput();

            // Clear paste preview
            clearPastePreview();

            showStatus('All inputs cleared. Ready for new image.', 'info');
        }

        // Clear paste preview
        function clearPastePreview() {
            const pastePreview = document.getElementById('pastePreview');
            const pasteArea = document.getElementById('pasteArea');

            pastePreview.style.display = 'none';
            pasteArea.classList.remove('paste-active', 'paste-ready');

            // Reset paste status
            updatePasteStatus();
        }

        // Show status message
        function showStatus(message, type) {
            const container = document.getElementById('statusContainer');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            
            container.appendChild(statusDiv);
            
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        // Generate all app store images
        async function generateAllImages() {
            if (!sourceImageData) {
                showStatus('Please upload a source image first.', 'error');
                return;
            }

            document.getElementById('generationSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            generatedImages = [];

            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            try {
                // Load source image
                const sourceImg = await loadImageFromData(sourceImageData);

                // Define the 5 required images
                const imageSpecs = [
                    { name: 'App Store Icon', width: 512, height: 512, type: 'icon', padding: 0.1 },
                    { name: 'Small App Icon', width: 114, height: 114, type: 'icon', padding: 0 },
                    { name: 'Feature Graphic 1', width: 1280, height: 800, type: 'feature', padding: 0 },
                    { name: 'Feature Graphic 2', width: 1280, height: 800, type: 'feature', padding: 0 },
                    { name: 'Feature Graphic 3', width: 1280, height: 800, type: 'feature', padding: 0 }
                ];

                // Generate each image
                for (let i = 0; i < imageSpecs.length; i++) {
                    const spec = imageSpecs[i];
                    progressText.textContent = `Generating ${spec.name}...`;
                    progressFill.style.width = `${(i / imageSpecs.length) * 100}%`;

                    const generatedImage = await generateImage(sourceImg, spec);
                    generatedImages.push(generatedImage);

                    // Small delay for better UX
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                progressFill.style.width = '100%';
                progressText.textContent = 'All images generated successfully!';

                // Show results
                displayGeneratedImages();
                document.getElementById('resultsSection').style.display = 'block';
                showStatus('All 5 app store images generated successfully!', 'success');

            } catch (error) {
                console.error('Generation error:', error);
                showStatus(`Generation failed: ${error.message}`, 'error');
            }
        }

        // Load image from data URL
        function loadImageFromData(dataUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load source image'));
                img.src = dataUrl;
            });
        }

        // Generate individual image based on specifications
        async function generateImage(sourceImg, spec) {
            const canvas = document.getElementById('processingCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = spec.width;
            canvas.height = spec.height;

            // Clear canvas with white background for feature graphics
            if (spec.type === 'feature') {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, spec.width, spec.height);
            } else {
                ctx.clearRect(0, 0, spec.width, spec.height);
            }

            if (spec.type === 'icon') {
                // For icons: center crop to square, then apply padding
                await drawIconImage(ctx, sourceImg, spec.width, spec.height, spec.padding);
            } else {
                // For feature graphics: preserve aspect ratio, center in canvas
                await drawFeatureImage(ctx, sourceImg, spec.width, spec.height);
            }

            // Convert to data URL
            const dataUrl = canvas.toDataURL('image/png', 1.0);
            const fileSize = Math.round(dataUrl.length * 0.75);

            return {
                name: spec.name,
                width: spec.width,
                height: spec.height,
                dataUrl: dataUrl,
                fileSize: fileSize,
                filename: `${spec.name.toLowerCase().replace(/\s+/g, '-')}-${spec.width}x${spec.height}.png`
            };
        }

        // Draw icon image with center cropping and optional padding
        async function drawIconImage(ctx, sourceImg, width, height, padding) {
            const sourceAspect = sourceImg.width / sourceImg.height;
            const targetAspect = 1; // Square for icons

            let drawWidth, drawHeight, drawX, drawY;

            if (sourceAspect > targetAspect) {
                // Source is wider - crop width
                drawHeight = sourceImg.height;
                drawWidth = sourceImg.height; // Make it square
                drawX = (sourceImg.width - drawWidth) / 2;
                drawY = 0;
            } else {
                // Source is taller - crop height
                drawWidth = sourceImg.width;
                drawHeight = sourceImg.width; // Make it square
                drawX = 0;
                drawY = (sourceImg.height - drawHeight) / 2;
            }

            // Apply padding
            const paddingPixels = width * padding;
            const finalSize = width - (paddingPixels * 2);
            const finalX = paddingPixels;
            const finalY = paddingPixels;

            // Enable high-quality rendering
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // Draw the cropped and scaled image
            ctx.drawImage(
                sourceImg,
                drawX, drawY, drawWidth, drawHeight,
                finalX, finalY, finalSize, finalSize
            );
        }

        // Draw feature image preserving aspect ratio
        async function drawFeatureImage(ctx, sourceImg, width, height) {
            const sourceAspect = sourceImg.width / sourceImg.height;
            const targetAspect = width / height;

            let drawWidth, drawHeight, drawX, drawY;

            if (sourceAspect > targetAspect) {
                // Source is wider - fit to width
                drawWidth = width;
                drawHeight = width / sourceAspect;
                drawX = 0;
                drawY = (height - drawHeight) / 2;
            } else {
                // Source is taller - fit to height
                drawHeight = height;
                drawWidth = height * sourceAspect;
                drawX = (width - drawWidth) / 2;
                drawY = 0;
            }

            // Enable high-quality rendering
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // Draw the scaled image centered
            ctx.drawImage(sourceImg, drawX, drawY, drawWidth, drawHeight);
        }

        // Display generated images in the UI
        function displayGeneratedImages() {
            const container = document.getElementById('generatedImages');
            container.innerHTML = '';

            generatedImages.forEach((img, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';

                card.innerHTML = `
                    <img src="${img.dataUrl}" alt="${img.name}">
                    <div class="image-title">${img.name}</div>
                    <div class="image-specs">${img.width}√ó${img.height}px ‚Ä¢ ${(img.fileSize/1024).toFixed(1)}KB</div>
                    <button class="btn" onclick="downloadImage(${index})">
                        üì• Download
                    </button>
                `;

                container.appendChild(card);
            });
        }

        // Download individual image
        function downloadImage(index) {
            if (index < 0 || index >= generatedImages.length) return;

            const img = generatedImages[index];
            const link = document.createElement('a');
            link.download = img.filename;
            link.href = img.dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showStatus(`Downloaded: ${img.name}`, 'success');
        }

        // Download all images
        function downloadAllImages() {
            if (generatedImages.length === 0) {
                showStatus('No images to download.', 'error');
                return;
            }

            generatedImages.forEach((img, index) => {
                setTimeout(() => {
                    downloadImage(index);
                }, index * 500); // Stagger downloads
            });

            showStatus(`Downloading all ${generatedImages.length} images...`, 'info');
        }

        // Regenerate images
        function regenerateImages() {
            generateAllImages();
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            initializeDragAndDrop();
            initializeClipboardPaste();
            console.log('Automated Image Generator loaded with paste support');
        });
    </script>
</body>
</html>
